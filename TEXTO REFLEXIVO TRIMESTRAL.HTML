import streamlit as st
from docx import Document
from io import BytesIO
import pandas as pd

# --- FUNCI√ìN PARA GENERAR EL WORD TRIMESTRAL ---
def generar_word_trimestral(datos_alumno, resumen_ia):
    doc = Document()
    doc.add_heading('EVALUACI√ìN REFLEXIVA TRIMESTRAL', 0)
    
    # Encabezado
    table = doc.add_table(rows=2, cols=2)
    table.cell(0,0).text = f"Educador Comunitario: {datos_alumno['ec']}"
    table.cell(0,1).text = f"Aprendiz: {datos_alumno['nombre']}"
    table.cell(1,0).text = f"Comunidad: {datos_alumno['comunidad']}"
    table.cell(1,1).text = f"Periodo: {datos_alumno['trimestre']}"

    doc.add_heading('An√°lisis del Avance Trimestral', level=1)
    doc.add_paragraph(resumen_ia)

    doc.add_heading('Logros Alcanzados', level=2)
    doc.add_paragraph(datos_alumno['logros'])

    doc.add_heading('Sugerencias para el Pr√≥ximo Periodo', level=2)
    doc.add_paragraph(datos_alumno['sugerencias'])

    buffer = BytesIO()
    doc.save(buffer)
    buffer.seek(0)
    return buffer

# --- INTERFAZ DEL MOTOR TRIMESTRAL ---
st.title("üìä Generador de Evaluaciones Trimestrales")
st.info("Este m√≥dulo jala la informaci√≥n de los registros diarios para crear la evaluaci√≥n final.")

# Simulaci√≥n de Base de Datos SQL (Aqu√≠ se conectar√≠an los registros previos)
if 'db_reflexiones' not in st.session_state:
    st.session_state['db_reflexiones'] = [] # Aqu√≠ se guardan los textos diarios

with st.sidebar:
    st.header("Base de Datos del Alumno")
    nombre_busqueda = st.text_input("Buscar nombre del alumno:")
    trimestre = st.selectbox("Trimestre a evaluar:", ["Primer Trimestre", "Segundo Trimestre", "Tercer Trimestre"])

# 1. Recuperar informaci√≥n (Simulando el SELECT de SQL)
# En una web real ser√≠a: cursor.execute("SELECT contenido FROM reflexiones WHERE alumno=...", (nombre_busqueda,))
datos_recuperados = [r for r in st.session_state['db_reflexiones'] if r['alumno'] == nombre_busqueda]

if nombre_busqueda and datos_recuperados:
    st.success(f"Se encontraron {len(datos_recuperados)} registros diarios para este trimestre.")
    
    # Juntamos todos los textos diarios para que la IA los analice
    historial_textos = " ".join([r['contenido'] for r in datos_recuperados])

    if st.button("‚ú® Generar Evaluaci√≥n Trimestral con IA"):
        # La IA analiza el historial y redacta la s√≠ntesis
        # Aqu√≠ simulamos la redacci√≥n extensiva
        sintesis_ia = f"""
        Tras el an√°lisis de los registros diarios de {nombre_busqueda}, se observa una evoluci√≥n significativa 
        en el Modelo ABCD. Al inicio del periodo, el aprendiz mostraba inter√©s en {datos_recuperados[0]['interes']}, 
        enfrentando retos constantes en la autonom√≠a. A trav√©s de la relaci√≥n tutora persistente, el alumno 
        ha logrado transitar de un pensamiento guiado a uno m√°s independiente. 
        
        Destaca su capacidad para resolver desaf√≠os en los rincones de aprendizaje, especialmente en el √°rea de 
        {datos_recuperados[-1]['campo']}. Su proceso reflexivo ha madurado, logrando ahora explicar sus propios 
        errores sin frustraci√≥n, lo que fortalece su rol como futuro tutor dentro de la comunidad.
        """
        
        datos_doc = {
            "ec": "Educador Comunitario",
            "nombre": nombre_busqueda,
            "comunidad": "Comunidad Ejemplo",
            "trimestre": trimestre,
            "logros": "Dominio de operaciones b√°sicas, mejora en la fluidez lectora y disposici√≥n para la tutor√≠a.",
            "sugerencias": "Reforzar el pensamiento cr√≠tico mediante desaf√≠os de investigaci√≥n m√°s complejos."
        }
        
        archivo_word = generar_word_trimestral(datos_doc, sintesis_ia)
        
        st.subheader("Vista Previa de la Evaluaci√≥n")
        st.write(sintesis_ia)
        
        st.download_button(
            label="üì• Descargar Evaluaci√≥n Trimestral (.docx)",
            data=archivo_word,
            file_name=f"Evaluacion_{nombre_busqueda}_{trimestre}.docx",
            mime="application/vnd.openxmlformats-officedocument.wordprocessingml.document"
        )
else:
    st.warning("No hay registros previos para este alumno. Aseg√∫rate de guardar los textos reflexivos diarios primero.")
